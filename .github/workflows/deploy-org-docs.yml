name: Deploy Organization Docs

on:
  schedule:
    # Runs daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      repo:
        description: 'Specific repo to deploy (leave empty for all)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: MuTech-BV

      - name: Deploy docs for all repos
        if: ${{ !inputs.repo }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "Fetching organization repositories..."

          # Initialize counters and result tracking
          deployed=()
          skipped_no_docs=()
          skipped_no_ci=()
          skipped_no_dispatch=()
          failed=()

          # Get all repos in the org
          repos=$(gh repo list MuTech-BV --json name --limit 200 -q '.[].name')

          for repo in $repos; do
            echo "Checking $repo..."

            # Check if repo has mkdocs.yml
            if gh api "repos/MuTech-BV/$repo/contents/mkdocs.yml" --silent 2>/dev/null; then
              echo "  â†’ Found mkdocs.yml, checking for CI workflow..."

              # Check if ci.yml workflow exists and has workflow_dispatch
              workflow_content=$(gh api "repos/MuTech-BV/$repo/contents/.github/workflows/ci.yml" --jq '.content' 2>/dev/null | base64 -d 2>/dev/null || echo "")

              if [ -z "$workflow_content" ]; then
                echo "  â†’ No ci.yml workflow found, skipping"
                skipped_no_ci+=("$repo")
              elif echo "$workflow_content" | grep -q "workflow_dispatch"; then
                # Trigger the CI workflow on main branch
                if gh workflow run ci.yml --repo "MuTech-BV/$repo" --ref main 2>/dev/null; then
                  echo "  â†’ Triggered CI workflow"
                  deployed+=("$repo")
                else
                  echo "  â†’ Failed to trigger workflow"
                  failed+=("$repo")
                fi
              else
                echo "  â†’ ci.yml exists but has no workflow_dispatch trigger, skipping"
                skipped_no_dispatch+=("$repo")
              fi
            else
              echo "  â†’ No mkdocs.yml found, skipping"
              skipped_no_docs+=("$repo")
            fi

            # Small delay to avoid rate limiting
            sleep 1
          done

          echo "Done!"

          # Generate job summary
          {
            echo "# ðŸ“š Docs Deployment Summary"
            echo ""
            echo "| Status | Count |"
            echo "|--------|-------|"
            echo "| âœ… Deployed | ${#deployed[@]} |"
            echo "| â­ï¸ No mkdocs.yml | ${#skipped_no_docs[@]} |"
            echo "| â­ï¸ No ci.yml | ${#skipped_no_ci[@]} |"
            echo "| â­ï¸ No workflow_dispatch | ${#skipped_no_dispatch[@]} |"
            echo "| âŒ Failed | ${#failed[@]} |"
            echo ""

            if [ ${#deployed[@]} -gt 0 ]; then
              echo "## âœ… Deployed"
              for r in "${deployed[@]}"; do echo "- $r"; done
              echo ""
            fi

            if [ ${#skipped_no_dispatch[@]} -gt 0 ]; then
              echo "## â­ï¸ Skipped (no workflow_dispatch trigger)"
              for r in "${skipped_no_dispatch[@]}"; do echo "- $r"; done
              echo ""
            fi

            if [ ${#skipped_no_ci[@]} -gt 0 ]; then
              echo "## â­ï¸ Skipped (no ci.yml)"
              for r in "${skipped_no_ci[@]}"; do echo "- $r"; done
              echo ""
            fi

            if [ ${#failed[@]} -gt 0 ]; then
              echo "## âŒ Failed"
              for r in "${failed[@]}"; do echo "- $r"; done
              echo ""
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Deploy docs for specific repo
        if: ${{ inputs.repo }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO: ${{ inputs.repo }}
        run: |
          echo "Deploying docs for $REPO..."

          # Check if repo has mkdocs.yml
          if ! gh api "repos/MuTech-BV/$REPO/contents/mkdocs.yml" --silent 2>/dev/null; then
            echo "# âŒ Deployment Failed" >> "$GITHUB_STEP_SUMMARY"
            echo "$REPO does not have mkdocs.yml" >> "$GITHUB_STEP_SUMMARY"
            echo "Error: $REPO does not have mkdocs.yml"
            exit 1
          fi

          # Check if ci.yml workflow exists and has workflow_dispatch
          workflow_content=$(gh api "repos/MuTech-BV/$REPO/contents/.github/workflows/ci.yml" --jq '.content' 2>/dev/null | base64 -d 2>/dev/null || echo "")

          if [ -z "$workflow_content" ]; then
            echo "# âŒ Deployment Failed" >> "$GITHUB_STEP_SUMMARY"
            echo "$REPO does not have ci.yml workflow" >> "$GITHUB_STEP_SUMMARY"
            echo "Error: $REPO does not have ci.yml workflow"
            exit 1
          elif ! echo "$workflow_content" | grep -q "workflow_dispatch"; then
            echo "# âŒ Deployment Failed" >> "$GITHUB_STEP_SUMMARY"
            echo "$REPO ci.yml has no workflow_dispatch trigger" >> "$GITHUB_STEP_SUMMARY"
            echo "Error: $REPO ci.yml has no workflow_dispatch trigger"
            exit 1
          fi

          gh workflow run ci.yml --repo "MuTech-BV/$REPO" --ref main
          echo "Triggered CI workflow for $REPO"

          echo "# âœ… Deployment Triggered" >> "$GITHUB_STEP_SUMMARY"
          echo "Triggered docs deployment for **$REPO**" >> "$GITHUB_STEP_SUMMARY"
