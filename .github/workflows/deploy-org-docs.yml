name: Deploy Organization Docs

on:
  schedule:
    # Runs daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      repo:
        description: 'Specific repo to deploy (leave empty for all)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: MuTech-BV

      - name: Deploy docs for all repos
        if: ${{ !inputs.repo }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "Fetching organization repositories..."

          # Get all repos in the org
          repos=$(gh repo list MuTech-BV --json name --limit 200 -q '.[].name')

          for repo in $repos; do
            echo "Checking $repo..."

            # Check if repo has mkdocs.yml
            if gh api "repos/MuTech-BV/$repo/contents/mkdocs.yml" --silent 2>/dev/null; then
              echo "  → Found mkdocs.yml, checking for CI workflow..."

              # Check if ci.yml workflow exists and has workflow_dispatch
              workflow_content=$(gh api "repos/MuTech-BV/$repo/contents/.github/workflows/ci.yml" --jq '.content' 2>/dev/null | base64 -d 2>/dev/null || echo "")

              if [ -z "$workflow_content" ]; then
                echo "  → No ci.yml workflow found, skipping"
              elif echo "$workflow_content" | grep -q "workflow_dispatch"; then
                # Trigger the CI workflow on main branch
                if gh workflow run ci.yml --repo "MuTech-BV/$repo" --ref main 2>/dev/null; then
                  echo "  → Triggered CI workflow"
                else
                  echo "  → Failed to trigger workflow"
                fi
              else
                echo "  → ci.yml exists but has no workflow_dispatch trigger, skipping"
              fi
            else
              echo "  → No mkdocs.yml found, skipping"
            fi

            # Small delay to avoid rate limiting
            sleep 1
          done

          echo "Done!"

      - name: Deploy docs for specific repo
        if: ${{ inputs.repo }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO: ${{ inputs.repo }}
        run: |
          echo "Deploying docs for $REPO..."

          # Check if repo has mkdocs.yml
          if ! gh api "repos/MuTech-BV/$REPO/contents/mkdocs.yml" --silent 2>/dev/null; then
            echo "Error: $REPO does not have mkdocs.yml"
            exit 1
          fi

          # Check if ci.yml workflow exists and has workflow_dispatch
          workflow_content=$(gh api "repos/MuTech-BV/$REPO/contents/.github/workflows/ci.yml" --jq '.content' 2>/dev/null | base64 -d 2>/dev/null || echo "")

          if [ -z "$workflow_content" ]; then
            echo "Error: $REPO does not have ci.yml workflow"
            exit 1
          elif ! echo "$workflow_content" | grep -q "workflow_dispatch"; then
            echo "Error: $REPO ci.yml has no workflow_dispatch trigger"
            exit 1
          fi

          gh workflow run ci.yml --repo "MuTech-BV/$REPO" --ref main
          echo "Triggered CI workflow for $REPO"
